{"version":3,"file":"Editor.js","sourceRoot":"","sources":["../../src/addons/Editor.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  EditV2,\n  EditEventV2,\n  OpenEvent,\n  newEditCompletedEvent,\n  newEditEvent,\n  handleEditV2,\n  isInsertV2,\n  isRemoveV2,\n  isSetAttributesV2,\n  isSetTextContentV2,\n  isComplexV2,\n  newEditEventV2\n} from '@openscd/core';\nimport {\n  property,\n  LitElement,\n  customElement,\n  TemplateResult,\n  html,\n  state,\n  query\n} from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport {\n  EditorAction,\n  EditorActionEvent,\n} from '@openscd/core/foundation/deprecated/editor.js';\n\nimport { newLogEvent } from '@openscd/core/foundation/deprecated/history.js';\nimport { newValidateEvent } from '@openscd/core/foundation/deprecated/validation.js';\nimport { OpenDocEvent } from '@openscd/core/foundation/deprecated/open-event.js';\n\nimport {\n  AttributeValue,\n  Edit,\n  EditEvent,\n  Insert,\n  isComplex,\n  isInsert,\n  isNamespaced,\n  isRemove,\n  isUpdate,\n  Remove,\n  Update,\n} from '@openscd/core';\n\nimport { convertEditActiontoV1 } from './editor/edit-action-to-v1-converter.js';\nimport { convertEditV1toV2 } from './editor/edit-v1-to-v2-converter.js';\n\nimport { WizardEvent, WizardFactory } from '../foundation.js';\nimport '../wizard-dialog.js';\nimport { WizardDialog } from '../wizard-dialog.js';\n\n@customElement('oscd-editor')\nexport class OscdEditor extends LitElement {\n  /** The `XMLDocument` to be edited */\n  @property({ attribute: false })\n  doc: XMLDocument | null = null;\n  /** The name of the current [[`doc`]] */\n  @property({ type: String }) docName = '';\n  /** The UUID of the current [[`doc`]] */\n  @property({ type: String }) docId = '';\n\n  @property({\n    type: Object,\n  })\n  host!: HTMLElement;\n\n  /** FIFO queue of [[`Wizard`]]s to display. */\n  @state()\n  workflow: WizardFactory[] = [];\n\n  @query('wizard-dialog') wizardUI!: WizardDialog;\n\n  private getLogText(edit: EditV2): { title: string, message?: string } {\n    if (isInsertV2(edit)) {\n      const name = edit.node instanceof Element ?\n        edit.node.tagName :\n        get('editing.node');\n      return { title: get('editing.created', { name }) };\n    } else if (isSetAttributesV2(edit) || isSetTextContentV2(edit)) {\n      const name = edit.element.tagName;\n      return { title: get('editing.updated', { name }) };\n    } else if (isRemoveV2(edit)) {\n      const name = edit.node instanceof Element ?\n        edit.node.tagName :\n        get('editing.node');\n      return { title: get('editing.deleted', { name }) };\n    } else if (isComplexV2(edit)) {\n      const message = edit.map(e => this.getLogText(e)).map(({ title }) => title).join(', ');\n      return { title: get('editing.complex'), message };\n    }\n\n    return { title: '' };\n  }\n\n  private onAction(event: EditorActionEvent<EditorAction>) {\n    const edit = convertEditActiontoV1(event.detail.action);\n    const editV2 = convertEditV1toV2(edit);\n\n    this.host.dispatchEvent(newEditEventV2(editV2));\n  }\n\n  handleEditEvent(event: EditEvent) {\n    /**\n     * This is a compatibility fix for plugins based on open energy tools edit events\n     * because their edit event look slightly different\n     * see https://github.com/OpenEnergyTools/open-scd-core/blob/main/foundation/edit-event-v1.ts for details\n     */\n    if (isOpenEnergyEditEvent(event)) {\n      event = convertOpenEnergyEditEventToEditEvent(event);\n    }\n\n    const edit = event.detail.edit;\n    const editV2 = convertEditV1toV2(edit);\n\n    this.host.dispatchEvent(newEditEventV2(editV2));\n  }\n\n  /**\n   *\n   * @deprecated [Move to handleOpenDoc instead]\n   */\n  private async onOpenDoc(event: OpenDocEvent) {\n    this.doc = event.detail.doc;\n    this.docName = event.detail.docName;\n    this.docId = event.detail.docId ?? '';\n\n    await this.updateComplete;\n\n    this.dispatchEvent(newValidateEvent());\n\n    this.dispatchEvent(\n      newLogEvent({\n        kind: 'info',\n        title: get('openSCD.loaded', { name: this.docName }),\n      })\n    );\n  }\n\n  handleOpenDoc({ detail: { docName, doc } }: OpenEvent) {\n    this.doc = doc;\n    this.docName = docName;\n  }\n\n  private onWizard(we: WizardEvent) {\n    const wizard = we.detail.wizard;\n    if (wizard === null) this.workflow.shift();\n    else if (we.detail.subwizard) this.workflow.unshift(wizard);\n    else this.workflow.push(wizard);\n    this.requestUpdate('workflow');\n    this.updateComplete.then(() =>\n      this.wizardUI.updateComplete.then(() =>\n        this.wizardUI.dialog?.updateComplete.then(() =>\n          this.wizardUI.dialog?.focus()\n        )\n      )\n    );\n  }\n\n  connectedCallback(): void {\n    super.connectedCallback();\n\n    // Deprecated editor action API, use 'oscd-edit' instead.\n    this.host.addEventListener('editor-action', this.onAction.bind(this));\n    // Deprecated edit event API, use 'oscd-edit-v2' instead.\n    this.host.addEventListener('oscd-edit', event => this.handleEditEvent(event));\n\n    this.host.addEventListener('oscd-edit-v2', event => this.handleEditEventV2(event));\n    this.host.addEventListener('open-doc', this.onOpenDoc);\n    this.host.addEventListener('oscd-open', this.handleOpenDoc);\n    this.host.addEventListener('wizard', this.onWizard.bind(this));\n    this.host.addEventListener('editor-action', () =>\n      this.wizardUI?.requestUpdate()\n    );\n  }\n\n  render(): TemplateResult {\n    return html`<slot></slot>\n      <wizard-dialog .wizard=${this.workflow[0]?.() ?? []}></wizard-dialog>`;\n  }\n\n  async handleEditEventV2(event: EditEventV2) {\n    const edit = event.detail.edit;\n\n    const undoEdit = handleEditV2(edit);\n\n    const shouldCreateHistoryEntry = event.detail.createHistoryEntry !== false;\n\n    if (shouldCreateHistoryEntry) {\n      const { title, message } = this.getLogText(edit);\n\n      this.dispatchEvent(newLogEvent({\n        kind: 'action',\n        title: event.detail.title ?? title,\n        message,\n        redo: edit,\n        undo: undoEdit,\n        squash: event.detail.squash\n      }));\n    }\n\n    await this.updateComplete;\n    this.dispatchEvent(newValidateEvent());\n  }\n}\n\nfunction isOpenEnergyEditEvent(event: CustomEvent<unknown>): boolean {\n  const eventDetail = event.detail as Edit;\n  return isComplex(eventDetail) || isInsert(eventDetail) || isUpdate(eventDetail) || isRemove(eventDetail);\n}\n\nfunction convertOpenEnergyEditEventToEditEvent(event: CustomEvent<unknown>): EditEvent {\n  const eventDetail = event.detail as Edit;\n  return newEditEvent(eventDetail);\n}\n"]}